{
	"name": "5-Quick Analysis Queries Using Views",
	"properties": {
		"content": {
			"query": "-- 1. Create basic enriched sales view\nCREATE OR ALTER VIEW dbo.vw_sales_enriched AS \nSELECT \n    s.*,\n    s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0) AS TotalAmount,\n    s.Quantity * s.UnitPrice AS GrossAmount,\n    CASE \n        WHEN s.Quantity * s.UnitPrice > 0 \n        THEN (ISNULL(s.Discount, 0) / (s.Quantity * s.UnitPrice)) * 100 \n        ELSE 0 \n    END AS DiscountPercentage,\n    YEAR(s.TransactionDate) AS TransactionYear,\n    MONTH(s.TransactionDate) AS TransactionMonth,\n    DATENAME(MONTH, s.TransactionDate) AS TransactionMonthName\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s;\nGO\n\n-- 2. Create monthly sales trend view\nCREATE OR ALTER VIEW dbo.vw_monthly_sales_trend AS\nSELECT \n    YEAR(s.TransactionDate) AS SalesYear,\n    MONTH(s.TransactionDate) AS SalesMonth,\n    DATEFROMPARTS(YEAR(s.TransactionDate), MONTH(s.TransactionDate), 1) AS SalesPeriod,\n    COUNT(*) AS TransactionCount,\n    SUM(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0)) AS MonthlyRevenue,\n    SUM(s.Quantity) AS TotalQuantity,\n    COUNT(DISTINCT s.CustomerID) AS UniqueCustomers,\n    COUNT(DISTINCT s.ProductID) AS UniqueProducts,\n    AVG(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0)) AS AvgTransactionValue\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s\nGROUP BY YEAR(s.TransactionDate), MONTH(s.TransactionDate);\nGO\n\n-- 3. Create product performance view\nCREATE OR ALTER VIEW dbo.vw_product_performance AS\nSELECT \n    p.ProductID,\n    p.ProductName,\n    p.Brand,\n    p.CategoryID,\n    COUNT(s.TransactionID) AS TransactionCount,\n    SUM(COALESCE(s.Quantity, 0)) AS TotalQuantitySold,\n    SUM(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS TotalRevenue,\n    AVG(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS AvgTransactionValue\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/products.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS p\nLEFT JOIN OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s ON p.ProductID = s.ProductID\nGROUP BY p.ProductID, p.ProductName, p.Brand, p.CategoryID;\nGO\n\n-- 4. Create customer analytics view\nCREATE OR ALTER VIEW dbo.vw_customer_analytics AS\nSELECT \n    c.CustomerID,\n    c.FirstName,\n    c.LastName,\n    c.City,\n    c.State,\n    COUNT(s.TransactionID) AS TotalTransactions,\n    SUM(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS TotalSpent,\n    AVG(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS AvgTransactionValue,\n    MIN(s.TransactionDate) AS FirstPurchaseDate,\n    MAX(s.TransactionDate) AS LastPurchaseDate\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/customers_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS c\nLEFT JOIN OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s ON c.CustomerID = s.CustomerID\nGROUP BY c.CustomerID, c.FirstName, c.LastName, c.City, c.State;\nGO\n\n-- 5. Create store performance view\nCREATE OR ALTER VIEW dbo.vw_store_performance AS\nSELECT \n    st.StoreID,\n    st.StoreName,\n    st.City,\n    st.State,\n    st.Region,\n    COUNT(s.TransactionID) AS TotalTransactions,\n    SUM(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS TotalRevenue,\n    SUM(COALESCE(s.Quantity, 0)) AS TotalQuantitySold,\n    COUNT(DISTINCT s.CustomerID) AS UniqueCustomers,\n    AVG(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS AvgTransactionValue\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/stores.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS st\nLEFT JOIN OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s ON st.StoreID = s.StoreID\nGROUP BY st.StoreID, st.StoreName, st.City, st.State, st.Region;\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "salesdata",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
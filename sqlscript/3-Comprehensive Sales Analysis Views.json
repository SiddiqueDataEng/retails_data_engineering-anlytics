{
	"name": "3-Comprehensive Sales Analysis Views",
	"properties": {
		"content": {
			"query": "-- 1. Daily Sales Summary View\nCREATE VIEW dbo.vw_daily_sales_summary AS\nSELECT \n    CAST(s.TransactionDate AS DATE) AS SalesDate,\n    COUNT(*) AS TotalTransactions,\n    SUM(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0)) AS DailyRevenue,\n    SUM(s.Quantity) AS TotalQuantitySold,\n    COUNT(DISTINCT s.CustomerID) AS UniqueCustomers,\n    COUNT(DISTINCT s.ProductID) AS UniqueProducts,\n    AVG(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0)) AS AvgTransactionValue,\n    SUM(ISNULL(s.Discount, 0)) AS TotalDiscounts\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s\nGROUP BY CAST(s.TransactionDate AS DATE);\nGO\n\n-- 2. Product Performance View\nCREATE VIEW dbo.vw_product_performance AS\nSELECT \n    p.ProductID,\n    p.ProductName,\n    p.Brand,\n    p.CategoryID,\n    p.SubcategoryID,\n    p.CostPrice,\n    p.SellingPrice,\n    COUNT(s.TransactionID) AS TransactionCount,\n    SUM(COALESCE(s.Quantity, 0)) AS TotalQuantitySold,\n    SUM(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS TotalRevenue,\n    AVG(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS AvgTransactionValue,\n    SUM(COALESCE(s.Quantity * (s.UnitPrice - p.CostPrice), 0)) AS TotalProfit,\n    CASE \n        WHEN SUM(COALESCE(s.Quantity * s.UnitPrice, 0)) > 0 \n        THEN (SUM(COALESCE(s.Quantity * (s.UnitPrice - p.CostPrice), 0)) / SUM(COALESCE(s.Quantity * s.UnitPrice, 0))) * 100 \n        ELSE 0 \n    END AS ProfitMarginPercentage\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/products.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS p\nLEFT JOIN OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s ON p.ProductID = s.ProductID\nGROUP BY p.ProductID, p.ProductName, p.Brand, p.CategoryID, p.SubcategoryID, p.CostPrice, p.SellingPrice;\nGO\n\n-- 3. Customer Analytics View\nCREATE VIEW dbo.vw_customer_analytics AS\nSELECT \n    c.CustomerID,\n    c.FirstName,\n    c.LastName,\n    c.City,\n    c.State,\n    c.Country,\n    COUNT(s.TransactionID) AS TotalTransactions,\n    SUM(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS TotalSpent,\n    AVG(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS AvgTransactionValue,\n    MIN(s.TransactionDate) AS FirstPurchaseDate,\n    MAX(s.TransactionDate) AS LastPurchaseDate,\n    DATEDIFF(DAY, MIN(s.TransactionDate), MAX(s.TransactionDate)) AS CustomerLifetimeDays,\n    COUNT(DISTINCT CAST(s.TransactionDate AS DATE)) AS ActiveDays,\n    COUNT(DISTINCT s.ProductID) AS UniqueProductsPurchased\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/customers_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS c\nLEFT JOIN OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s ON c.CustomerID = s.CustomerID\nGROUP BY c.CustomerID, c.FirstName, c.LastName, c.City, c.State, c.Country;\nGO\n\n-- 4. Store Performance View\nCREATE VIEW dbo.vw_store_performance AS\nSELECT \n    st.StoreID,\n    st.StoreName,\n    st.City,\n    st.State,\n    st.Region,\n    st.StoreType,\n    COUNT(s.TransactionID) AS TotalTransactions,\n    SUM(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS TotalRevenue,\n    SUM(COALESCE(s.Quantity, 0)) AS TotalQuantitySold,\n    COUNT(DISTINCT s.CustomerID) AS UniqueCustomers,\n    AVG(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS AvgTransactionValue,\n    COUNT(DISTINCT s.ProductID) AS UniqueProducts,\n    SUM(COALESCE(ISNULL(s.Discount, 0), 0)) AS TotalDiscountsGiven\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/stores.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS st\nLEFT JOIN OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s ON st.StoreID = s.StoreID\nGROUP BY st.StoreID, st.StoreName, st.City, st.State, st.Region, st.StoreType;\nGO\n\n-- 5. Monthly Sales Trend View\nCREATE VIEW dbo.vw_monthly_sales_trend AS\nSELECT \n    YEAR(s.TransactionDate) AS SalesYear,\n    MONTH(s.TransactionDate) AS SalesMonth,\n    DATEFROMPARTS(YEAR(s.TransactionDate), MONTH(s.TransactionDate), 1) AS SalesPeriod,\n    COUNT(*) AS TransactionCount,\n    SUM(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0)) AS MonthlyRevenue,\n    SUM(s.Quantity) AS TotalQuantity,\n    COUNT(DISTINCT s.CustomerID) AS UniqueCustomers,\n    COUNT(DISTINCT s.ProductID) AS UniqueProducts,\n    AVG(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0)) AS AvgTransactionValue,\n    SUM(ISNULL(s.Discount, 0)) AS TotalDiscounts\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s\nGROUP BY YEAR(s.TransactionDate), MONTH(s.TransactionDate);\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "salesdata",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
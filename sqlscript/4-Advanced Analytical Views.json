{
	"name": "4-Advanced Analytical Views",
	"properties": {
		"content": {
			"query": "-- 6. Customer Segmentation View\nCREATE VIEW dbo.vw_customer_segments AS\nWITH CustomerMetrics AS (\n    SELECT \n        c.CustomerID,\n        c.FirstName + ' ' + c.LastName AS CustomerName,\n        c.State,\n        c.City,\n        COUNT(s.TransactionID) AS TransactionCount,\n        SUM(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS TotalSpent,\n        AVG(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS AvgTransactionValue,\n        DATEDIFF(DAY, MIN(s.TransactionDate), MAX(s.TransactionDate)) AS CustomerLifetime,\n        COUNT(DISTINCT s.ProductID) AS UniqueProducts\n    FROM OPENROWSET(\n        BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/customers_clean.parquet/*.parquet',\n        FORMAT = 'PARQUET'\n    ) AS c\n    JOIN OPENROWSET(\n        BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n        FORMAT = 'PARQUET'\n    ) AS s ON c.CustomerID = s.CustomerID\n    GROUP BY c.CustomerID, c.FirstName, c.LastName, c.State, c.City\n)\nSELECT *,\n    CASE \n        WHEN TotalSpent > 1000 AND TransactionCount > 15 THEN 'VIP'\n        WHEN TotalSpent > 500 AND TransactionCount > 8 THEN 'Premium'\n        WHEN TotalSpent > 200 THEN 'Standard'\n        ELSE 'Basic'\n    END AS CustomerSegment,\n    CASE \n        WHEN CustomerLifetime > 180 THEN 'Long-Term'\n        WHEN CustomerLifetime > 90 THEN 'Medium-Term'\n        ELSE 'New'\n    END AS CustomerTenure,\n    NTILE(4) OVER (ORDER BY TotalSpent DESC) AS SpendingQuartile,\n    NTILE(4) OVER (ORDER BY TransactionCount DESC) AS FrequencyQuartile\nFROM CustomerMetrics;\nGO\n\n-- 7. Regional Sales Analysis View\nCREATE VIEW dbo.vw_regional_sales AS\nSELECT \n    st.Region,\n    st.State,\n    COUNT(DISTINCT st.StoreID) AS StoreCount,\n    COUNT(s.TransactionID) AS TotalTransactions,\n    SUM(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS TotalRevenue,\n    SUM(COALESCE(s.Quantity, 0)) AS TotalQuantitySold,\n    COUNT(DISTINCT s.CustomerID) AS UniqueCustomers,\n    COUNT(DISTINCT s.ProductID) AS UniqueProducts,\n    AVG(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS AvgTransactionValue,\n    SUM(COALESCE(ISNULL(s.Discount, 0), 0)) AS TotalDiscounts\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/stores.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS st\nJOIN OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s ON st.StoreID = s.StoreID\nGROUP BY st.Region, st.State;\nGO\n\n-- 8. Payment Method Analysis View\nCREATE VIEW dbo.vw_payment_analysis AS\nSELECT \n    s.PaymentMethod,\n    COUNT(*) AS TransactionCount,\n    SUM(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0)) AS TotalAmount,\n    AVG(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0)) AS AvgTransactionValue,\n    COUNT(DISTINCT s.CustomerID) AS UniqueCustomers,\n    COUNT(DISTINCT s.StoreID) AS StoresUsed,\n    MIN(s.TransactionDate) AS FirstUsage,\n    MAX(s.TransactionDate) AS LastUsage,\n    SUM(ISNULL(s.Discount, 0)) AS TotalDiscounts\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s\nGROUP BY s.PaymentMethod;\nGO\n\n-- 9. Product Category Performance View\nCREATE VIEW dbo.vw_category_performance AS\nSELECT \n    p.CategoryID,\n    COUNT(DISTINCT p.ProductID) AS ProductCount,\n    COUNT(DISTINCT p.SubcategoryID) AS SubcategoryCount,\n    SUM(COALESCE(s.Quantity, 0)) AS TotalQuantitySold,\n    SUM(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS TotalRevenue,\n    COUNT(DISTINCT s.CustomerID) AS UniqueCustomers,\n    COUNT(DISTINCT s.StoreID) AS StoresSelling,\n    AVG(COALESCE(s.Quantity * s.UnitPrice - ISNULL(s.Discount, 0), 0)) AS AvgTransactionValue,\n    SUM(COALESCE(s.Quantity * (s.UnitPrice - p.CostPrice), 0)) AS TotalProfit\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/products.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS p\nLEFT JOIN OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/sales_clean.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS s ON p.ProductID = s.ProductID\nGROUP BY p.CategoryID;\nGO\n\n-- 10. Retail Analytical Dataset View (if needed)\nCREATE VIEW dbo.vw_retail_analytical_enriched AS \nSELECT \n    ra.*,\n    DATEPART(YEAR, ra.TransactionDate) AS TransactionYear,\n    DATEPART(MONTH, ra.TransactionDate) AS TransactionMonth,\n    DATEPART(QUARTER, ra.TransactionDate) AS TransactionQuarter\nFROM OPENROWSET(\n    BULK 'https://adls4salesdata.blob.core.windows.net/transformed-data/retail_analytical_dataset.parquet/*.parquet',\n    FORMAT = 'PARQUET'\n) AS ra;\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "salesdata",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}